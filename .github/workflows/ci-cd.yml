name: Frontend CI/CD

env:
  REGISTRY: "registry.digitalocean.com/hakeyn-registry"
  IMAGE_NAME: "sense-frontend-image"
  CONTAINER_NAME: "sense-frontend-container"

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: [ main, master, development ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'index.html'
      - 'Dockerfile'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [ main, master, development ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'index.html'
      - 'Dockerfile'
      - '.github/workflows/ci-cd.yml'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: npm ci

    - name: Run Jest tests
      run: npm test -- --watchAll=false

    - name: Run Jest coverage
      run: npm run test:coverage

  build_docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t sense-frontend:latest .

  build_static:
    name: Build Static Files
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: npm ci

    - name: Build static files
      run: npm run build

    - name: Copy index.html to 404.html
      run: cp dist/index.html dist/404.html

    - name: Upload static build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: static-build
        path: dist/
        retention-days: 1

  build_and_push:
    name: Build and Push to Digital Ocean
    runs-on: ubuntu-latest
    needs: build_docker
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 600

    - name: Build and push container image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | head -c7)
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy_digital_ocean:
    name: Deploy to Digital Ocean Droplet
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Deploy to Digital Ocean droplet via SSH
      uses: appleboy/ssh-action@v0.1.3
      env:
        GITHUB_SHA: ${{ github.sha }}
      with:
        host: ${{ secrets.FRONTEND_HOST }}
        username: ${{ secrets.FRONTEND_USERNAME }}
        key: ${{ secrets.FRONTEND_SSH_PRIVATE_KEY }}
        envs: IMAGE_NAME,REGISTRY,CONTAINER_NAME,GITHUB_SHA
        script: |
          # Login into Digital Ocean Registry
          docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} $REGISTRY

          # Stop running containers
          docker stop $CONTAINER_NAME || true

          # Remove old containers
          docker rm $CONTAINER_NAME || true

          # Pull new image
          docker pull $REGISTRY/$IMAGE_NAME:${GITHUB_SHA:0:7}

          # Run a new container from a new image
          docker run -d \
            --restart always \
            -p 3000:80 \
            --name $CONTAINER_NAME \
            $REGISTRY/$IMAGE_NAME:${GITHUB_SHA:0:7}

  deploy_github_pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build_static
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development'

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: static-build
        path: ./dist

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4.4.1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: dist
        target-folder: ${{ github.ref == 'refs/heads/main' && '' || 'staging' }}
        clean: true
        commit-message: "Deploy ${{ github.ref_name }} branch"
        single-commit: true

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: Automated release from main branch
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show deployment URLs
      run: |
        echo "### Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "**Production URL:** [https://fpmi-hci-2025.github.io/project11a-web-sense/](https://fpmi-hci-2025.github.io/project11a-web-sense/)" >> $GITHUB_STEP_SUMMARY
        echo "**Staging URL:** [https://fpmi-hci-2025.github.io/project11a-web-sense/staging/](https://fpmi-hci-2025.github.io/project11a-web-sense/staging/)" >> $GITHUB_STEP_SUMMARY
